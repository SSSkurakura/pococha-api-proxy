<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ユニットオリジナル曲 -ランキング画面-</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 16px;
      max-width: 800px;
      margin: auto;
    }
    h1 {
      margin-bottom: 16px;
      font-size: 1.5rem;
    }
    #intro {
      margin-bottom: 24px;
      padding: 16px;
      background: #f9f9f9;
      border-radius: 6px;
      font-size: 0.95rem;
      line-height: 1.5;
    }
    /* キャンバスの高さを固定し、横幅は100% */
    #barChart {
      width: 100%;
      height: 400px;
    }
  </style>
</head>
<body>
  <h1>ユニットオリジナル曲 -ランキング画面-</h1>
  <!-- 追加：説明文 -->
  <section id="intro">
    ここでは、「ユニットオリジナル曲イベント」に参加した各グループの応援ポイントの平均得点を比較して、表示しています。<br>
    ※本ページは、最終結果とは異なる可能性がございますので、事前にご了承ください。
  </section>
  <canvas id="barChart"></canvas>

  <script>
    // ——（1）表示したい eventId のリスト——
    const eventIds = [
      '01JPGY77RX9AHKM3TTQ12FE6JT',
      // ここに他の eventId を追加してください（カンマを忘れずに）
    ];

    // totals, counts は後でツールチップで使うために外側で宣言
    let totals = [];
    let counts = [];

    // ——（2）全イベントのデータを proxy 経由で取得——
    const fetches = eventIds.map(id =>
      fetch(`/api/proxy?eventId=${id}`)
        .then(res => {
          if (!res.ok) throw new Error(`proxy エラー: ${res.status}`);
          return res.json();
        })
    );

    Promise.all(fetches)
      .then(results => {
        const labels = [];   // イベント名
        const averages = []; // 平均点

        results.forEach(json => {
          // (a) グループ名を取得
          labels.push(json.event.name);

          // (b) 全タブの全メンバーのスコアをまとめる
          const scores = json.rank_tabs.flatMap(tab =>
            tab.ranks.map(r => r.score)
          );

          // (c) 合計と平均を計算
          const total = scores.reduce((sum, x) => sum + x, 0);
          const count = scores.length || 1;
          const avg = total / count;

          totals.push(total);
          counts.push(count);
          averages.push(Math.round(avg));
        });

        drawChart(labels, averages);
      })
      .catch(err => {
        document.body.insertAdjacentHTML(
          'beforeend',
          '<p style="color:red;">データ取得中にエラーが発生しました。</p>'
        );
        console.error(err);
      });

    // ——（3）Chart.js で横棒グラフを描画——
    function drawChart(labels, data) {
      const ctx = document.getElementById('barChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '平均得点',
            data: data,
            barThickness: 20
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',        // 横棒グラフにする
          scales: {
            x: {
              beginAtZero: true,
              ticks: { font: { size: 14 } }
            },
            y: {
              ticks: { font: { size: 14 } }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(ctx) {
                  const idx = ctx.dataIndex;
                  return [
                    `平均点: ${ctx.formattedValue}`,
                    `合計点: ${totals[idx]}`,
                    `ユニット人数: ${counts[idx]}`
                  ];
                }
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
