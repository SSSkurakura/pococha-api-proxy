<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ユニットオリジナル曲 -ランキング画面-</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 16px;
      max-width: 800px;
      margin: auto;
    }
    h1 {
      margin-bottom: 16px;
      font-size: 1.5rem;
    }
    #intro {
      margin-bottom: 24px;
      padding: 16px;
      background: #f9f9f9;
      border-radius: 6px;
      font-size: 0.95rem;
      line-height: 1.5;
    }
    /* 追加：グラフを包むコンテナ */
    .chart-container {
      max-height: 400px;    /* 高さ上限 */
      overflow-y: auto;     /* はみ出したら縦スクロール */
      margin-bottom: 24px;
    }
    /* canvas 自体は幅100% */
    #barChart {
      width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <h1>ユニットオリジナル曲 -ランキング画面-</h1>
  <section id="intro">
    ここでは、「ユニットオリジナル曲イベント」に参加した各グループの応援ポイントの平均得点を比較して、表示しています。<br>
    ※本ページは、最終結果とは異なる可能性がございますので、事前にご了承ください。
  </section>

  <!-- ここを div.chart-container でラップ -->
  <div class="chart-container">
    <canvas id="barChart"></canvas>
  </div>

  <script>
    const eventIds = [
      '01JPGY77RX9AHKM3TTQ12FE6JT',
      '01JPGY77RX9AHKM3TTQ12FE6JT',
      // 他の eventId をカンマ区切りで追加
    ];

    let totals = [], counts = [];

    const fetches = eventIds.map(id =>
      fetch(`/api/proxy?eventId=${id}`)
        .then(res => {
          if (!res.ok) throw new Error(`proxy エラー: ${res.status}`);
          return res.json();
        })
    );

    Promise.all(fetches)
      .then(results => {
        const labels = [], averages = [];

        results.forEach(json => {
          labels.push(json.event.name);
          const scores = json.rank_tabs.flatMap(tab =>
            tab.ranks.map(r => r.score)
          );
          const total = scores.reduce((s, x) => s + x, 0);
          const count = scores.length || 1;
          totals.push(total);
          counts.push(count);
          averages.push(Math.round(total / count));
        });

        drawChart(labels, averages);
      })
      .catch(err => {
        document.body.insertAdjacentHTML(
          'beforeend',
          '<p style="color:red;">データ取得中にエラーが発生しました。</p>'
        );
        console.error(err);
      });

    function drawChart(labels, data) {
      const ctx = document.getElementById('barChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '平均得点',
            data: data,
            barThickness: 20
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          scales: {
            x: { beginAtZero: true, ticks: { font: { size: 14 } } },
            y: { ticks: { font: { size: 14 } } }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const i = ctx.dataIndex;
                  return [
                    `平均点: ${ctx.formattedValue}`,
                    `合計点: ${totals[i].toLocaleString()}`, 
                    `ユニット人数: ${counts[i]}`
                  ];
                }
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
